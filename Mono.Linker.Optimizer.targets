<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup Condition="'$(LinkerOptimizerEnabled)' != 'false'">
    <LinkBlazorApplicationDependsOn>
      $(LinkBlazorApplicationDependsOn);
      _PrepareLinkerOptimizerConfiguration;
      _ComputeLinkerOptimizerDependencies;
    </LinkBlazorApplicationDependsOn>

    <MonoLinkerPath>$(MSBuildThisFileDirectory)\bin\Debug\netcoreapp2.0\Mono.Linker.Optimizer.dll</MonoLinkerPath>
  </PropertyGroup>

  <PropertyGroup Condition="'$(LinkerOptimizerEnabled)' == 'false'">
    <MonoLinkerPath>$(MSBuildThisFileDirectory)\bin\Debug\netcoreapp2.0\illink.dll</MonoLinkerPath>
  </PropertyGroup>

  <Target
      Name="_PrepareLinkerOptimizerConfiguration"
      AfterTargets="_PrepareBlazorOutputConfiguration"
      Condition="'$(LinkerOptimizerEnabled)' != 'false'">

    <PropertyGroup>
      <_LinkerOptimizerDependencyCache>$(BlazorIntermediateOutputPath)linker-optimizer.cache</_LinkerOptimizerDependencyCache>
      <_LinkerOptimizerResponseFile>$(BlazorIntermediateOutputPath)linker-optimizer.response</_LinkerOptimizerResponseFile>
    </PropertyGroup>
  </Target>

  <Target
      Name="_ComputeLinkerOptimizerDependencies"
      DependsOnTargets="_PrepareLinkerOptimizerConfiguration"
      Inputs="@(LinkerOptimizerXmlDescriptors)"
      Outputs="$(_LinkerOptimizerDependencyCache);$(_LinkerOptimizerResponseFile)"
      Condition="'$(LinkerOptimizerEnabled)' != 'false'"
  >

    <Message Text="Using Linker Optimizer XML: %(LinkerOptimizerXmlDescriptors.Identity)!" />
    <Message Text="Using Linker Optimizer Arguments: $(LinkerOptimizerOptions)"  Condition="'$(LinkerOptimizerOptions)' != ''" />
    <Message Text="Using Linker Optimizer Report: $(LinkerOptimizerReport)"  Condition="'$(LinkerOptimizerReport)' != ''" />

    <ItemGroup>
      <_LinkerOptimizerXmlArguments Include="@(LinkerOptimizerXmlDescriptors->'--optimizer-xml &quot;%(FullPath)&quot;')" Condition="'@(LinkerOptimizerXmlDescriptors)' != ''" />
    </ItemGroup>

    <PropertyGroup>
      <_LinkerOptimizerArguments>--optimizer %(IntermediateAssembly.FullPath)</_LinkerOptimizerArguments>
      <_LinkerOptimizerOptions Condition="'$(LinkerOptimizerOptions)' != ''">--optimizer-options $(LinkerOptimizerOptions)</_LinkerOptimizerOptions>
      <_LinkerOptimizerReport Condition="'$(LinkerOptimizerReport)' != ''">--optimizer-report $(LinkerOptimizerReport)</_LinkerOptimizerReport>
      <_LinkerOptimizerExtraLinkerDesc>$(MSBuildThisFileDirectory)\Tests\Blazor\extra-linker-descriptor.xml</_LinkerOptimizerExtraLinkerDesc>
      <_LinkerOptimizerCommandLine>$(_LinkerOptimizerArguments) @(_LinkerOptimizerXmlArguments, ' ') $(_LinkerOptimizerOptions) $(_LinkerOptimizerReport) $(LinkerOptimizerExtraArguments) $(LinkerOptimizerExtraLinkerArguments) -x $(_LinkerOptimizerExtraLinkerDesc) </_LinkerOptimizerCommandLine>
      <AdditionalMonoLinkerOptions>$(_LinkerOptimizerCommandLine) $(AdditionalMonoLinkerOptions)</AdditionalMonoLinkerOptions>
      <MonoLinkerPath>$(MSBuildThisFileDirectory)\bin\Debug\netcoreapp2.0\Mono.Linker.Optimizer.dll</MonoLinkerPath>
    </PropertyGroup>

    <Hash ItemsToHash="@(LinkerOptimizerXmlDescriptors);$(_LinkerOptimizerCommandLine)">
      <Output TaskParameter="HashResult" PropertyName="_LinkerOptimizerDependencyHash" />
    </Hash>

    <WriteLinesToFile
      Lines="$(_LinkerOptimizerDependencyHash)"
      File="$(_LinkerOptimizerDependencyCache)"
      Overwrite="True"
      WriteOnlyWhenDifferent="True" />

    <WriteLinesToFile
      Lines="$(_LinkerOptimizerCommandLine)"
      FIle="$(_LinkerOptimizerResponseFile)"
      Overwrite="True"
      WriteOnlyWhenDifferent="True" />

    <Message Text="Generated response file: $(_LinkerOptimizerResponseFile)" />

    <ItemGroup>
      <BlazorBuildLinkerExtraInputs Include="$(_LinkerOptimizerResponseFile)" />
      <BlazorBuildLinkerExtraInputs Include="$(_LinkerOptimizerExtraLinkerDesc)" />
      <BlazorBuildLinkerExtraInputs Include="$(_LinkerOptimizerDependencyCache)" />
      <BlazorBuildLinkerExtraInputs Include="@(LinkerOptimizerXmlDescriptors)" />
    </ItemGroup>

  </Target>

</Project>
